(()=>{var Yt=Object.defineProperty;var Re=o=>Yt(o,"__esModule",{value:!0});var Ae=(o,t)=>{Re(o);for(var e in t)Yt(o,e,{get:t[e],enumerable:!0})};var Xt={},_e={};function Qt(o){o.parentNode&&o.parentNode.removeChild(o),Array.from(o.children).forEach(t=>{Xt[t.className]=t})}function Zt(o){let t=_e[o];return t&&t.length>0?t.pop():Xt[o].cloneNode(!0)}function B(o){o=Object.assign({type:"div"},o);let t=document.createElement(o.type);if(o.classes&&t.setAttribute("class",o.classes),o.innerHTML&&(t.innerHTML=o.innerHTML),o.children&&o.children.forEach(t.appendChild,t),o.parent&&o.parent.appendChild(t),o.attributes)for(let e in o.attributes)t.setAttribute(e,o.attributes[e]);return t}var te=class{constructor(t,e,s,i){this.callback=e,this.scope=s,this.args=i,this.once=!1,this.executed=!1}exec(t){this.callback.apply(this.scope,[...t,...this.args])}},at=class{constructor(){this.listeners=[]}add(t,e,...s){if(t===void 0)throw new Error("no callback specified");let i=this.listeners.length;for(let r=0;r<i;r++){let a=this.listeners[r];if(a.callback===t&&a.scope===e)return a}let n=new te(this,t,e,Array.from(s));return this.listeners.push(n),n}addOnce(t,e,...s){let i=this.add(t,e,...s);return i.once=!0,i}remove(t,e){let s=this.listeners.length;for(let i=0;i<s;i++){let n=this.listeners[i];if(n.callback==t&&n.scope==e){this.listeners.splice(i,1);return}}}listenEvt(t,e){let s=this.dispatch.bind(this);return t.addEventListener(e,s),{target:t,evtName:e,func:s}}unlistenEvt(t){t.target.removeEventListener(t.evtName,t.func)}dispatch(){let t=Array.prototype.slice.call(arguments);for(let s=0,i=this.listeners.length;s<i;s++){let n=this.listeners[s];n!==void 0&&(n.once&&(this.listeners[s]=void 0),n.exec(t))}let e=this.listeners.length;for(;e--;)this.listeners[e]===void 0&&this.listeners.splice(e,1)}dispose(){this.listeners=[]}},h=at;var lt=[],W=class{static create(t=0,e=0){return lt.length>0?lt.pop().set(t,e):new W(t,e)}static dist2(t,e){let s=e.x-t.x,i=e.y-t.y;return s*s+i*i}static dist(t,e){let s=e.x-t.x,i=e.y-t.y;return Math.hypot(s,i)}static angle(t,e){let s=Math.atan2(t.y,t.x),i=Math.atan2(e.y,e.x);return s+i}static lerp(t,e,s){return t.clone().lerp(t,e,s)}constructor(t,e){this.set(t,e)}add(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}scale(t,e){return this.x*=t,this.y*=e,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}divide(t){return this.x/=t.x,this.y/=t.y,this}lerp(t,e,s){return this.copy(e).sub(t).multiplyScalar(s).add(t),this}clone(){return W.create(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}set(t=0,e=0){return this.x=t,this.y=e,this}normalize(){return this.setLength(1)}setLength(t){let e=t/this.getLength();return this.x*=e,this.y*=e,this}getLength(){return Math.hypot(this.x,this.y)}getLengthSquared(){return this.x*this.x+this.y*this.y}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}rotate(t){let e=Math.cos(t),s=Math.sin(t),i=this.x,n=this.y;return this.x=e*i-s*n,this.y=e*n+s*i,this}dispose(){lt.push(this)}},d=W;function M(o,t,e){return o+e*(t-o)}function C(o,t,e){return Math.max(o,Math.min(t,e))}function et(o){return 3*o**2-2*o**3}function P(o){let t=[],e=o.length,s=(a,l)=>a.clone().sub(l).normalize(),i=a=>new d(-a.y,a.x),n=new d,r=new d;for(let a=1;a<e-1;a++){let l=o[a],c=s(l,o[a-1]),u=s(o[a+1],l);t[a]=i(c.clone().add(u).normalize())}return t[0]=i(s(o[1],o[0])),t[e-1]=i(s(o[e-1],o[e-2])),t}var dt=class{constructor(){this.duration=0,this.timeBegin=Number.NEGATIVE_INIFITY}start(t,e=0){this.duration=t,this.timeBegin=Date.now()+1e3*e}reset(){this.timeBegin=Number.NEGATIVE_INIFITY}end(){this.timeBegin=0}get value(){return C(0,1,(Date.now()-this.timeBegin)/(1e3*this.duration))}},ee=dt;var ct=class{constructor(){this.canvas=document.createElement("canvas"),this.saveProgressed=new h,this.saveCompleted=new h}start(t,e,s){this.srcCanvas=t;let i=this.srcCanvas.width/this.srcCanvas.height,n=e/s;this.result={},i>n?(this.result.width=e,this.result.height=Math.floor(e/i)):(this.result.height=s,this.result.width=Math.floor(s*i)),this.canvas.width=this.result.width,this.canvas.height=this.result.height,this.result.dx=0,this.result.dy=0,this.gif=new GIF({width:this.result.width,height:this.result.height,workers:4,workerScript:"/gif.worker.js",quality:3}),this.isCapturing=!0}capture(){let t=this.canvas.getContext("2d"),e=this.srcCanvas.width,s=this.srcCanvas.height,{width:i,height:n,dx:r,dy:a}=this.result;t.drawImage(this.srcCanvas,0,0,e,s,0,0,i,n),this.gif.addFrame(this.canvas,{copy:!0,delay:1e3/30})}stop(){this.gif.on("progress",t=>{this.saveProgressed.dispatch(t)}),this.gif.on("finished",t=>{download(t,"drawing"),this.saveCompleted.dispatch()}),this.gif.render(),this.isCapturing=!1}},se=ct;var f=class{static fromMemento(t){let e=new f;return e.fromMemento(t),e}static fromString(t){let e=/hsla\((\d+), *(\d+)%, *(\d+)%, *(\d+.?\d*)\)/,s=t.match(e);return new f(Number(s[1]),Number(s[2]),Number(s[3]),Number(s[4]))}static fromHex(t){return new f().setHex(t)}constructor(t=0,e=0,s=0,i=1){this.set(t,e,s,i)}setH(t){return this.h=t,this}setS(t){return this.s=t,this}setL(t){return this.l=t,this}setA(t){return this.a=t,this}set(t=0,e=0,s=0,i=1){this.h=t,this.s=e,this.l=s,this.a=i}copy(t){return this.h=t.h,this.s=t.s,this.l=t.l,this.a=t.a,this}clone(){return new f().copy(this)}setRGB(t,e,s){t/=255,e/=255,s/=255;let i=Math.min(t,e,s),n=Math.max(t,e,s),r=n-i,a,l,c;if(c=(n+i)/2,r===0)a=0,l=0;else{c<.5?l=r/(n+i):l=r/(2-n-i);let u=((n-t)/6+r/2)/r,g=((n-e)/6+r/2)/r,m=((n-s)/6+r/2)/r;t===n?a=m-g:e===n?a=1/3+u-m:s===n&&(a=2/3+g-u),a<0&&(a+=1),a>1&&(a-=1)}return this.h=360*a,this.s=100*l,this.l=100*c,this}toRGB(){let t=(this.h/360%1+1)%1,e=this.s/100,s=this.l/100;if(s>=1)return{r:255,g:255,b:255};if(e===0)return s=Math.round(255*s),{r:s,g:s,b:s};let i=s<.5?s*(1+e):s+e-s*e,n=2*s-i,r=[];for(let a=0;a<3;a++){let l=t+(1-a)/3,c=n;l<0?l+=1:l>1&&(l-=1),l<1/6?c=n+(i-n)*6*l:l<1/2?c=i:l<2/3&&(c=n+(i-n)*(2/3-l)*6),r[a]=Math.round(c*255)}return{r:r[0],g:r[1],b:r[2]}}setHex(t){return this.setRGB(t>>16&255,t>>8&255,t&255)}getHex(){let t=this.toRGB();return t.r<<16|t.g<<8|t.b}toMemento(){return[Math.round(this.h),Math.round(this.s),Math.round(this.l),Math.round(1e3*this.a)]}fromMemento(t){this.set(...t),this.a=t[3]/1e3}toString(){let t=Math.round(this.h),e=Math.round(this.s),s=Math.round(this.l),i=this.a;return`hsla(${t}, ${e}%, ${s}%, ${i})`}precomputeString(){this.string=this.toString()}equals(t){return this.h===t.h&&this.s===t.s&&this.l===t.l&&this.a===t.a}},p=f;f.BLACK=new f(0,0,0);f.WHITE=new f(0,0,100);f.RED=new f(0,100,50);f.GREEN=new f(120,100,50);f.BLUE=new f(240,100,50);f.CYAN=new f(180,100,50);f.MAGENTA=new f(300,100,50);f.YELLOW=new f(60,100,50);function st(o,t){return parseInt(o.getPropertyValue(t),10)}function Ne(o){let t=0,e=0,s=!0;do{t+=o.offsetLeft,e+=o.offsetTop;let i=window.getComputedStyle(o,null),n=st(i,"border-top-width"),r=st(i,"border-left-width");if(e+=n,t+=r,s){let a=st(i,"padding-top"),l=st(i,"padding-left");e+=a,t+=l}s=!1}while(Boolean(o=o.offsetParent));return{x:t,y:e}}var ut=class{constructor(t){this.x=this.y=0,this.isDown=!1,this.isRightDown=!1,this.target=t||document,this.onDown=new h,this.onUp=new h,this.onDrag=new h,this.onMiddleDown=new h,this.onMiddleDrag=new h,this.onMiddleUp=new h,this.onRightDown=new h,this.onRightDrag=new h,this.onRightUp=new h,this.onMove=new h,this.onWheel=new h,this._moveBind=this._onMouseMove.bind(this),this._downBind=this._onMouseDown.bind(this),this._upBind=this._onMouseUp.bind(this),this._touchMoveBind=this._onTouchMove.bind(this),this._touchStartBind=this._onTouchStart.bind(this),this._touchEndBind=this._onTouchEnd.bind(this),this._wheelBind=this._onMouseWheel.bind(this),this._contextBind=e=>(e.preventDefault(),!1),this._enabled=!1}enable(){this._enabled||(document.addEventListener("mousemove",this._moveBind),this.target.addEventListener("mousedown",this._downBind),document.addEventListener("mouseup",this._upBind),document.addEventListener("touchmove",this._touchMoveBind),this.target.addEventListener("touchstart",this._touchStartBind),this.target.addEventListener("mousewheel",this._wheelBind),this.target.addEventListener("DOMMouseScroll",this._wheelBind),this.target.addEventListener("contextmenu",this._contextBind),this._enabled=!0)}disable(){document.removeEventListener("mousemove",this._moveBind),this.target.removeEventListener("mousedown",this._downBind),document.removeEventListener("mouseup",this._upBind),document.removeEventListener("touchmove",this._touchMoveBind),this.target.removeEventListener("touchstart",this._touchStartBind),document.removeEventListener("touchend",this._touchEndBind),this.target.removeEventListener("mousewheel",this._wheelBind),this.target.removeEventListener("DOMMouseScroll",this._wheelBind),this.target.removeEventListener("contextmenu",this._contextBind),this._enabled=!1}_updatePositionFromEvent(t){let e=Ne(this.target);this.x=(t.pageX||t.touches&&t.touches[0]&&t.touches[0].pageX)-e.x||0,this.y=(t.pageY||t.touches&&t.touches[0]&&t.touches[0].pageY)-e.y||0}_onMouseMove(t){this._updatePositionFromEvent(t),this.onMove.dispatch(t),this.isDown&&this.onDrag.dispatch(t),this.isMiddleDown&&this.onMiddleDrag.dispatch(t),this.isRightDown&&this.onRightDrag.dispatch(t)}_onMouseDown(t){if(this.isTouching)return!1;if(this._updatePositionFromEvent(t),!t.which)return this.isDown=!0,this.onDown.dispatch(t),!1;switch(t.which){case 1:this.isDown=!0,this.onDown.dispatch(t);break;case 2:this.isMiddleDown=!0,this.onMiddleDown.dispatch(t);break;case 3:this.isRightDown=!0,this.onRightDown.dispatch(t);break}return!1}_onMouseUp(t,e=!1){if(!e&&this.isTouching)return!1;if(this._updatePositionFromEvent(t),!t.which)return this.isDown=!1,this.onUp.dispatch(t),!1;switch(t.which){case 1:this.isDown=!1,this.onUp.dispatch(t);break;case 2:this.isMiddleDown=!1,this.onMiddleUp.dispatch(t);break;case 3:this.isRightDown=!1,this.onRightUp.dispatch(t);break}return!1}_onMouseWheel(t){let e=0;t.wheelDelta!==void 0?e=t.wheelDelta:t.detail!==void 0&&(e=-t.detail),this.onWheel.dispatch(e)}_onTouchStart(t){t.preventDefault(),this.target.addEventListener("touchend",this._touchEndBind,{passive:!1}),this._onMouseDown(t),this.isTouching=!0}_onTouchEnd(t){t.preventDefault(),this.target.removeEventListener("touchend",this._touchEndBind),this._onMouseUp(t,!0),this.isTouching=!1}_onTouchMove(t){t.preventDefault(),this._onMouseMove(t)}setCursor(t="default"){this.target.style.cursor=t}dispose(){this.onDown.dispose(),this.onUp.dispose(),this.onMove.dispose(),this.onMiddleDown.dispose(),this.onMiddleUp.dispose(),this.onMiddleMove.dispose(),this.onRightDown.dispose(),this.onRightUp.dispose(),this.onRightMove.dispose(),this.disable()}},D=ut;function j(o,t){let e=t.length;for(var s=1;s<e-1;s++){let r=t[s];var i=t[s+1];o.quadraticCurveTo(r.x,r.y,.5*(r.x+i.x),.5*(r.y+i.y))}let n=t[e-1];o.lineTo(n.x,n.y)}function $(o,t){if(!(t.length<2)){o.beginPath();var e=t[0];o.moveTo(e.x,e.y),j(o,t),o.stroke()}}var mt=class{constructor(t){this.mouse=new D(t),this.lineStarted=new h,this.lineCreated=new h,this.mouse.onDown.add(this.onMouseDown,this)}onMouseDown(t){this.isDrawing=!0,document.body.classList.add("isDrawing"),this.pts=[new d(this.mouse.x,this.mouse.y)],this.timeBegin=Date.now(),this.mouse.onUp.add(this.onMouseUp,this),this.mouse.onMove.add(this.onMouseMove,this),this.lineStarted.dispatch()}onMouseMove(){let t=new d(this.mouse.x,this.mouse.y);this.pts.push(t)}onMouseUp(){if(this.isDrawing=!1,document.body.classList.remove("isDrawing"),this.pts.length>0){let t=[this.pts[0]];for(let e=1,s=this.pts.length;e<s;e++){let i=this.pts[e],n=t[t.length-1];d.dist(i,n)>10&&t.push(i)}this.lineCreated.dispatch(t,this.timeBegin,Date.now())}this.mouse.onUp.remove(this.onMouseUp,this),this.mouse.onMove.remove(this.onMouseMove,this)}enable(){this.mouse.enable()}disable(){this.isDrawing=!1,document.body.classList.remove("isDrawing"),this.mouse.disable()}draw(t){$(t,this.pts)}},ie=mt;var K={};Ae(K,{Avoid:()=>G,Bend:()=>q,Contract:()=>O,Filament:()=>U,Fluctuate:()=>N,Growing:()=>_,Loop:()=>A,Normal:()=>T,Ripple:()=>I,Wave:()=>F});var qe={},Ge={},T=class{static get settings(){return qe}static get settingsGui(){return Ge}constructor(t){this.settings=Object.assign({},T.settings,t)}init(t){this.result=t.map(e=>e.clone()),t.length>1?this.normals=P(this.result):this.normals=[new d(1,0)]}apply(t,e){return this.result.forEach((s,i)=>s.copy(t[i])),{pts:this.result}}applyPreview(t){return this.result=t.concat(),{pts:this.result}}};T.inkName="Normal";var Oe={amplitude:15,speed:.0035,frequency:.01},Ue={amplitude:{label:"amplitude",min:0,max:30},speed:{label:"speed",min:0,max:.025},frequency:{label:"frequency",min:0,max:.1}},F=class{static get settings(){return Oe}static get settingsGui(){return Ue}constructor(t){this.settings=Object.assign({},F.settings,t)}init(t,e,s){this.timeBegin=e,this.result=t.map(i=>i.clone()),t.length>1&&(this.normals=P(t))}apply(t,e){if(t.length===1){let n=-this.settings.speed*e+this.settings.frequency+this.timeBegin;return this.result[0].set(Math.cos(n),Math.sin(n)).multiplyScalar(this.settings.amplitude).add(t[0]),{pts:this.result}}let s,i=0;return t.forEach((n,r)=>{s&&(i+=d.dist(n,s)),s=n;let a=this.settings.amplitude*Math.sin(-this.settings.speed*e+this.settings.frequency*i);this.result[r].copy(this.normals[r]).multiplyScalar(a).add(n)}),{pts:this.result}}applyPreview(t){return this.result=t.concat(),{pts:this.result}}};F.inkName="Wave";var Ve={speed:.15,maxAmplitude:400},We={speed:{label:"speed",min:.01,max:.8},maxAmplitude:{label:"max amplitude",min:.001,max:1e3}},I=class{static get settings(){return Ve}static get settingsGui(){return We}constructor(t){this.settings=Object.assign({},I.settings,t)}init(t,e){this.timeBegin=e,this.result=t.map(s=>s.clone()),t.length>1&&(this.normals=P(t))}apply(t,e){if(t.length===1)return{pts:[t[0]]};let s=e-this.timeBegin,i=this.settings.speed*s%this.settings.maxAmplitude;t.forEach((r,a)=>{this.result[a].copy(this.normals[a]).setLength(i).add(r)});let n=i/this.settings.maxAmplitude;return{pts:this.result,normals:this.normals.map((r,a)=>{let l=et(1-2*Math.abs(n-.5));return r.clone().multiplyScalar(l)})}}applyPreview(t){return this.result=t,{pts:this.result}}};I.inkName="Ripple";var oe=class{constructor(t,e,s,i){this.c0=t,this.c1=e,this.c2=s,this.c3=i}getControls(){return{p0:this.c0,p1:this.c1/3+this.c0,p2:(this.c2+2*this.c1)/3+this.c0,p3:this.c0+this.c1+this.c2+this.c3}}eval(t){let e=t*t,s=e*t;return this.c0+this.c1*t+this.c2*e+this.c3*s}getTangent(t){let e=t*t;return this.c1+2*this.c2*t+3*this.c3*e}},pt=class{constructor(t){this.pts=t,this.curves=[];let e=t.length;if(e<1)throw new Error("not enough points");if(e===2)this.curves[0]=this.initCentripetalCR(t[0],t[0],t[1],t[1]);else if(e>2&&(this.curves[0]=this.initCentripetalCR(t[0],t[0],t[1],t[2]),e>3)){for(let s=0;s<e-3;s++)this.curves[s+1]=this.initCentripetalCR(t[s],t[s+1],t[s+2],t[s+3]);this.curves[e-2]=this.initCentripetalCR(t[e-3],t[e-2],t[e-1],t[e-1])}}initCentripetalCR(t,e,s,i){let n=Math.pow(d.dist2(t,e),.25),r=Math.pow(d.dist2(e,s),.25),a=Math.pow(d.dist2(s,i),.25);return r<1e-4&&(r=1),n<1e-4&&(n=r),a<1e-4&&(a=r),{x:this.initCubicPoly(t.x,e.x,s.x,i.x,n,r,a),y:this.initCubicPoly(t.y,e.y,s.y,i.y,n,r,a)}}initCubicPoly(t,e,s,i,n,r,a){let l=r*((e-t)/n-(s-t)/(n+r))+(s-e),c=r*((i-s)/a-(i-e)/(r+a))+(s-e);return new oe(e,l,-3*e+3*s-2*l-c,2*e-2*s+l+c)}getLocalPos(t){if(t===1)return{curve:this.curves[this.curves.length-1],pos:1};let e=this.curves.length,s=Math.floor(t*e);return{curve:this.curves[s],pos:t*e-s}}eval(t){if(this.pts.length===1)return this.pts[0].clone();if(t===1)return this.pts[this.pts.length-1].clone();let e=this.getLocalPos(t);return d.create(e.curve.x.eval(e.pos),e.curve.y.eval(e.pos))}getTangent(t){let e=this.getLocalPos(t);return d.create(e.curve.x.getTangent(e.pos),e.curve.y.getTangent(e.pos))}},R=pt;var je={lengthRatio:.3,pause:0},He={lengthRatio:{label:"length",min:1e-4,max:1},pause:{label:"pause duration",min:0,max:3}},A=class{static get settings(){return je}static get settingsGui(){return He}constructor(t){this.settings=Object.assign({},A.settings,t),this.result=[]}init(t,e,s){this.spline=new R(t),this.timeBegin=e,this.timeEnd=s}apply(t,e,s){if(t.length===1)return this.result=[t[0]],{pts:this.result};this.result&&(this.result.forEach(l=>l.dispose()),this.result.length=0);let i=this.timeEnd-this.timeBegin,n=i+1e3*this.settings.pause,r=C(0,1,(e-this.timeBegin)%n/i)*(this.settings.lengthRatio+1),a=r-this.settings.lengthRatio;return this.computeResult(this.spline,r,a)}computeResult(t,e,s){e=C(0,1,e),s=C(0,1,s);let i=Math.floor(this.settings.lengthRatio*t.pts.length);if(i<2)return{pts:[t.eval(s)],normals:[new d(1,0)]};let n=1/(i-1);for(let r=0;r<i;r++){let a=M(s,e,r*n);this.result[r]=t.eval(a)}return{pts:this.result}}applyPreview(t){return this.result&&(this.result.forEach(e=>e.dispose()),this.result.length=0),this.computeResult(new R(t),1,1-this.settings.lengthRatio)}};A.inkName="Loop";var ze={pause:0},Je={pause:{label:"pause duration",min:0,max:10}},_=class{static get settings(){return ze}static get settingsGui(){return Je}constructor(t){this.settings=Object.assign({},_.settings,t),this.result=[]}init(t,e,s){this.spline=new R(t),this.timeBegin=e,this.timeEnd=s}apply(t,e){let s=t.length,i=this.timeEnd-this.timeBegin,n=i+1e3*this.settings.pause,r=.5-C(0,1,.5*(e-this.timeBegin)%n/i),l=(Math.cos(r*2*Math.PI)*.5+.5)/(s-1);this.result=[];for(let c=0;c<s;c++)this.result[c]=this.spline.eval(c*l);return{pts:this.result}}applyPreview(t){return this.result=t.concat(),{pts:this.result}}};_.inkName="Growing";var $e={thicknessFactor:.1,speed:.0035,frequency:.01},Ke={thicknessFactor:{label:"thickness factor",min:0,max:1},speed:{label:"speed",min:0,max:.025},frequency:{label:"frequency",min:0,max:.1}},N=class{static get settings(){return $e}static get settingsGui(){return Ke}constructor(t){this.settings=Object.assign({},N.settings,t)}init(t,e){this.timeBegin=e,this.result=t.map(s=>s.clone()),t.length>1&&(this.normals=P(t))}apply(t,e){if(t.length===1){let r=this.settings.speed*e+this.timeBegin,a=this.settings.thicknessFactor+(1-this.settings.thicknessFactor)*(.5+.5*Math.sin(r));return{pts:this.result,normals:[new d(a,0)]}}let s,i=0,n=this.normals.map((r,a)=>{let l=this.result[a];s&&(i+=d.dist(l,s)),s=l;let c=-this.settings.speed*e+this.settings.frequency*i,u=this.settings.thicknessFactor+(1-this.settings.thicknessFactor)*(.5+.5*Math.sin(c));return r.clone().multiplyScalar(u)});return{pts:this.result,normals:n}}applyPreview(t){return this.result=t.concat(),{pts:this.result}}};N.inkName="Fluctuate";var Ye={radius:150,inertia:.05,spr:.001,spr2:.005},Xe={radius:{label:"radius",min:0,max:300},inertia:{label:"stability",min:0,max:.25},spr:{label:"stabilisation",min:1e-4,max:.01},spr2:{label:"repulsion",min:5e-4,max:.05}},q=class{static get settings(){return Ye}static get settingsGui(){return Xe}constructor(t){this.settings=Object.assign({},q.settings,t)}init(t){this.result=t.map(e=>e.clone()),this.velocities=t.map(e=>new d)}apply(t,e,s){let i=Math.pow(this.settings.radius,2),n=d.create(),r=d.create();return this.result.forEach((a,l)=>{let c=this.velocities[l];if(s){r.copy(s).sub(a);let u=r.getLengthSquared();if(u>0&&u<i){let g=this.settings.radius/Math.sqrt(u);n.copy(s).sub(r.multiplyScalar(g)).sub(a).multiplyScalar(this.settings.spr2),c.add(n)}}n.copy(t[l]).sub(a).multiplyScalar(this.settings.spr),c.multiplyScalar(1-this.settings.inertia).add(n),a.add(c)}),n.dispose(),r.dispose(),{pts:this.result}}applyPreview(t){return this.result=t.concat(),{pts:this.result}}};q.inkName="Bend";var Qe={radius:150,friction:.05,spr:.001,spr2:.005},Ze={radius:{label:"radius",min:0,max:300},friction:{label:"stability",min:0,max:.25},spr:{label:"stabilisation",min:1e-4,max:.01},spr2:{label:"repulsion",min:5e-4,max:.05}},G=class{static get settings(){return Qe}static get settingsGui(){return Ze}constructor(t){this.settings=Object.assign({},G.settings,t)}init(t){this.result=t.map(e=>e.clone()),t.length>1?this.normals=P(this.result):this.normals=[new d(1,0)],this.velocity=new d,this.offset=new d}apply(t,e,s){let i=this.velocity,n=d.create();if(s){let r=d.create(),a=this.result.reduce((m,w,Kt)=>{r.copy(s).sub(w);let tt=r.getLengthSquared();return tt<m.dist&&(m.diff.copy(r),m.dist=tt,m.pt=w),m},{diff:d.create(),dist:Number.MAX_VALUE,pt:void 0,id:void 0}),l=a.pt,c=a.diff,u=a.dist,g=Math.pow(this.settings.radius,2);if(u>0&&u<g){let m=this.settings.radius/Math.sqrt(u);n.copy(s).sub(c.multiplyScalar(m)).sub(l).multiplyScalar(this.settings.spr2),i.add(n)}c.dispose(),r.dispose()}return n.copy(t[0]).sub(this.result[0]).multiplyScalar(this.settings.spr),i.multiplyScalar(1-this.settings.friction).add(n),this.offset.add(i),this.result.forEach((r,a)=>r.copy(t[a]).add(this.offset)),n.dispose(),{pts:this.result,normals:this.normals}}applyPreview(t){return this.result=t.concat(),{pts:this.result}}};G.inkName="Avoid";var ts={radius:150,inertia:.2,spr:.1,spr2:.02,scale:3},es={radius:{label:"radius",min:0,max:300},inertia:{label:"stability",min:0,max:.25},spr:{label:"stabilisation",min:0,max:1},spr2:{label:"pointer influence",min:0,max:1},scale:{label:"strength",min:0,max:5}},O=class{static get settings(){return ts}static get settingsGui(){return es}constructor(t){this.settings=Object.assign({},O.settings,t)}init(t){this.result=t.map(e=>e.clone()),this.scales=t.map(e=>1),this.velocities=t.map(e=>0),t.length>1?this.normals=P(t):this.normals=[new d(1,0)]}apply(t,e,s){let i=Math.pow(this.settings.radius,2),n=d.create(),r=this.normals.map((a,l)=>{let c=this.result[l],u=this.velocities[l];if(s){let g=d.dist(s,c);if(g<this.settings.radius){let m=M(this.settings.scale,1,g/this.settings.radius);u+=this.settings.spr*(m-this.scales[l])}}return u+=this.settings.spr2*(1-this.scales[l]),u*=1-this.settings.inertia,this.velocities[l]=u,this.scales[l]+=u,a.clone().setLength(this.scales[l])});return{pts:this.result,normals:r}}applyPreview(t){return this.result=t.concat(),{pts:this.result}}};O.inkName="Contract";var ss={influence:.2,acc:.5,friction:.02},is={influence:{label:"pointer influence",min:.01,max:.4},acc:{label:"randomness",min:.01,max:.8},friction:{label:"stability",min:0,max:.1}},U=class{static get settings(){return ss}static get settingsGui(){return is}constructor(t){this.settings=Object.assign({},U.settings,t)}init(t){this.velocities=t.map(e=>new d),this.origins=t.map(e=>e.clone()),this.pts=t.map(e=>e.clone()),this.dists=t.map((e,s)=>s===0?0:d.dist(e,t[s-1])),this.result=[]}apply(t,e,s){let i=d.create();this.pts.forEach((l,c)=>{if(c===0)return;let u=this.velocities[c];i.set(Math.random()*2-1,Math.random()*2-1).multiplyScalar(this.settings.acc);let g;s&&d.dist2(s,l)!==0?g=l.clone().sub(s).setLength(this.settings.influence):d.dist2(this.origins[c],l)!==0&&(g=this.origins[c].clone().sub(l).setLength(this.settings.influence)),g&&u.multiplyScalar(1-this.settings.friction).add(i).add(g),l.add(u);let m=this.pts[c-1];l.sub(m).setLength(this.dists[c]).add(m)}),i.dispose();let n=new R(this.pts),r=this.pts.length,a=.75;for(let l=0;l<a*r;l++)this.result[l]=n.eval(C(0,1,l/(a*r-1)));return{pts:this.result}}applyPreview(t){return this.result=t.concat(),{pts:this.result}}};U.inkName="Filament";var y={func0:o=>Math.pow(.5*(Math.cos(o*Math.PI)+1),1),func1:o=>Math.pow(1-.5*(Math.cos(o*Math.PI)+1),1),func2:o=>1-.5*(Math.cos(o*2*Math.PI)+1),func3:o=>1};var ne={};Object.values(K).forEach(o=>{ne[o.inkName]=o});var H={LINE:"line",FILL:"fill"},Y=class{constructor(t){this.resolution=t,this.inkClass=void 0,this.ink=void 0,this.pts=void 0,this.fill={color:p.WHITE.toString(),enabled:!0},this.stroke={color:p.BLACK.toString(),enabled:!0,thickness:2},this.transform={count:1,reflection:!0},this.strokeMode=H.FILL,this.isEraser=!1,this.thicknessFunc=void 0,this.thickness=void 0,this.saveId=void 0}setGesture(t,e,s){this.pts=t,this.timeBegin=e,this.timeEnd=s,this.ink&&this.ink.init(t,e,s)}getStrokeMode(t){let e=p.fromString(t.color).a;return!t.enabled||e!==1?H.LINE:H.FILL}setFill(t,e){this.fill.color=t.toString(),this.fill.enabled=e}setStroke(t,e){this.stroke.color=t.toString(),this.stroke.enabled=e}setStrokeThickness(t){this.stroke.thickness=t}copy(t){return this.fill.color=t.fill.color,this.fill.enabled=t.fill.enabled,this.stroke.color=t.stroke.color,this.stroke.thickness=t.stroke.thickness,this.stroke.enabled=t.stroke.enabled,this.strokeMode=this.getStrokeMode(this.fill),this.thickness=t.thickness,this.thicknessFunc=t.thicknessFunc,this.transform={...t.transform},this.inkClass=t.inkClass,this.ink=new this.inkClass(t.ink.settings),this.pts&&this.ink.init(this.pts,this.timeBegin,this.timeEnd),this.isEraser=t.isEraser,this}clone(){return new Y(this.resolution).copy(this)}update(t,e){let{pts:s,normals:i}=this.ink.apply(this.pts,t,e);if(this.result=s,i&&(this.normals=i),this.result.length>=2){i||(this.normals=P(this.result));let n=1/(this.result.length-1);this.normals=this.normals.map((r,a)=>r.clone().multiplyScalar(this.thickness*this.thicknessFunc(a*n)))}else i||(this.normals=[new d(1,0)])}updatePreview(){let{pts:t,normals:e}=this.ink.applyPreview(this.pts);this.result=t,this.normals=e||P(this.result);let s=1/(this.result.length-1);this.normals=this.normals.map((i,n)=>i.clone().multiplyScalar(this.thickness*this.thicknessFunc(n*s)))}setResolution(t){this.resolution=t}getMemento(){return{resolution:this.resolution,timeBegin:this.timeBegin,timeEnd:this.timeEnd,inkClass:this.inkClass.inkName,ink:this.ink.settings,pts:os(this.pts),saveId:this.saveId,fill:{color:this.fill.color,enabled:this.fill.enabled},stroke:{color:this.stroke.color,thickness:this.stroke.thickness,enabled:this.stroke.enabled},isEraser:this.isEraser,thickness:this.thickness,transform:{...this.transform},thicknessFunc:(()=>{for(let t in y)if(y[t]===this.thicknessFunc)return t;return""})()}}setMemento(t){if(this.resolution=t.resolution,this.timeBegin=t.timeBegin||Math.floor(M(0,1e4,Math.random())),this.timeEnd=t.timeEnd||this.timeBegin+Math.floor(M(1e3,5e3,Math.random())),t.saveId&&(this.saveId=t.saveId),(t.motionClass==="Wave1"||t.inkClass==="Wave1")&&(t.inkClass="Wave"),this.inkClass=ne[t.inkClass||t.motionClass],this.inkClass||(console.error(`unknown ink class: ${t.inkClass}. Defaulting to ${Object.keys(K)[0]}`),this.inkClass=Object.values(K)[0]),this.ink=new this.inkClass(t.ink||t.motion),Array.isArray(t.fill.color)){let e=new p;e.fromMemento(t.fill.color),this.fill.color=e.toString()}else this.fill.color=t.fill.color;if(this.fill.enabled=t.fill.enabled===!0||t.fill.color[4]===!0,Array.isArray(t.stroke.color)){let e=new p;e.fromMemento(t.stroke.color),this.stroke.color=e.toString()}else this.stroke.color=t.stroke.color;this.strokeMode=this.getStrokeMode(this.fill),this.stroke.thickness=t.stroke.thickness,this.stroke.enabled=t.stroke.enabled===!0||t.stroke.color[4]===!0,this.isEraser=t.isEraser,this.transform=t.transform?{count:t.transform.count||1,reflection:t.transform.reflection||!1}:{count:1},this.thicknessFunc=y[t.thicknessFunc],this.thickness=t.thickness,this.setGesture(ns(t.pts),this.timeBegin,this.timeEnd)}},it=Y;function os(o){let t=[];return o.forEach((e,s)=>{t[2*s]=Math.round(e.x),t[2*s+1]=Math.round(e.y)}),t}function ns(o){let t=o.length/2,e=[];for(let s=0;s<t;s++)e.push(new d(o[2*s],o[2*s+1]));return e}var L=[p.WHITE,p.BLACK,new p(360,77,53),new p(36,100,59),new p(54,100,50),new p(105,100,68),new p(200,100,67),new p(320,100,80)],X=class{static fromMemento(t){let e=new X;return e.setMemento(t),e}constructor(){this.clear(),this.background=p.WHITE.toString()}addLine(t){this.lines[this.currentId]=t,t.savingState=this.currentId++,this.lines.length=this.currentId}setBackground(t){this.background=t}undo(){this.currentId>0&&this.currentId--}redo(){this.currentId<this.lines.length&&this.currentId++}clear(){this.lines=[],this.colors=L.concat(),this.currentId=0}getVisibleLines(){return this.lines.slice(0,this.currentId)}getCurrentLine(){return this.lines[this.currentId-1]}getMemento(){let t=[];for(let e=0;e<this.currentId;e++)t[e]=this.lines[e].getMemento();return{background:this.background,colors:this.colors.map(e=>e.getHex()),lines:t}}setMemento(t){if(t.background)if(Array.isArray(t.background)){let e=new p;e.fromMemento(t.background),this.background=e.toString()}else this.background=t.background;else this.background=p.WHITE.toString();t.colors?this.colors=t.colors.map(e=>p.fromHex(e)):t.colors=L.concat(),t.lines.forEach(e=>{let s=new it;s.setMemento(e),this.addLine(s)})}},E=X;var gt=class{constructor(t){this.dom=t,this.fileSelected=new h,this.onFileSelectedBind=this.onFileSelected.bind(this)}onFileSelected(t){let e=t.target.files[0];if(e){let s=new FileReader;s.readAsText(e,"UTF-8"),s.onload=i=>{this.fileSelected.dispatch(i.target.result)},s.onerror=function(i){console.error("error reading file")}}}enable(){this.dom.addEventListener("change",this.onFileSelectedBind,!1)}disable(){this.dom.removeEventListener("change",this.onFileSelectedBind)}},re=gt;var ft=class{constructor(t,e){this.dom=t,this.rolledOver=new h,this.rolledOut=new h,this.clicked=new h,this._enabled=!1,this.enable()}enable(){this.enabled||(this._enabled=!0,this.dom.classList.remove("disabled"),this.overBind=this.rolledOver.listenEvt(this.dom,"mouseenter"),this.outBind=this.rolledOut.listenEvt(this.dom,"mouseleave"),this.clickBind=this.clicked.listenEvt(this.dom,"click"))}disable(){!this.enabled||(this._enabled=!1,this.dom.classList.add("disabled"),this.rolledOver.unlistenEvt(this.overBind),this.rolledOut.unlistenEvt(this.outBind),this.clicked.unlistenEvt(this.clickBind))}set enabled(t){t?this.enable():this.disable()}get enabled(){return this._enabled}},k=ft;var b=class{constructor(t){this.dom=t,this.dom.classList.add("fillPreview")}setColor(t,e=!0){e?(this.dom.style.backgroundColor=t.toString(),this.dom.classList.remove("disabled"),t.l>=50?this.dom.classList.add("white"):this.dom.classList.remove("white")):(this.dom.removeAttribute("style"),this.dom.classList.add("disabled"),this.dom.classList.remove("white"))}},Q=class{constructor(t){this.dom=t,this.dom.classList.add("strokePreview")}setColor(t,e=!0){e?(this.dom.style.borderColor=t.toString(),this.dom.classList.remove("disabled")):(this.dom.classList.add("disabled"),this.dom.removeAttribute("style"))}setThickness(t){Object.assign(this.dom.style,{borderWidth:.5*t+"px"})}};var kt=class{constructor(t){this.dom=t,this.backgroundClicked=new h,this.undoClicked=new h,this.redoClicked=new h,this.modeClicked=new h,this.inkClicked=new h,this.fillClicked=new h,this.strokeClicked=new h,this.thicknessClicked=new h,this.clearClicked=new h,this.aboutClicked=new h,this.shareClicked=new h,this.isVisible=!0,this.initDom()}initDom(){let t=n=>this.dom.querySelector(n),e=n=>n.dom.querySelector(".colorBtn-preview");this.toolBar=t("menu-toolbar");function s(n,r,a){let l=new k(t(".menu-"+n));return l.clicked.add(()=>r.dispatch(a)),l}function i(n,r){let a=new k(t(".menu-"+n));return a.clicked.add(()=>r.dispatch()),a}this.backgroundBtn=i("backgroundBtn",this.backgroundClicked),this.backgroundPreview=new b(e(this.backgroundBtn)),this.undoBtn=i("undoBtn",this.undoClicked),this.redoBtn=i("redoBtn",this.redoClicked),this.drawBtn=s("drawBtn",this.modeClicked,v.DRAW),this.eraseBtn=s("eraseBtn",this.modeClicked,v.ERASE),this.interactBtn=s("interactBtn",this.modeClicked,v.INTERACT),this.inkBtn=i("inkBtn",this.inkClicked),this.fillBtn=i("fillBtn",this.fillClicked),this.fillPreview=new b(e(this.fillBtn)),this.strokeBtn=i("strokeBtn",this.strokeClicked),this.strokePreview=new Q(e(this.strokeBtn)),this.thicknessBtn=i("thicknessBtn",this.thicknessClicked),this.thicknessIcon=this.thicknessBtn.dom.querySelector(".iconBtn-icon"),this.clearBtn=i("clearBtn",this.clearClicked),this.aboutBtn=i("aboutBtn",this.aboutClicked),this.shareBtn=i("shareBtn",this.shareClicked)}setBackground(t){this.backgroundPreview.setColor(t)}setMode(t){let e={[v.DRAW]:this.drawBtn,[v.ERASE]:this.eraseBtn,[v.INTERACT]:this.interactBtn};for(let s in e)e[s].dom.classList.toggle("selected",s===t)}setUndoState(t,e){this.undoBtn.enabled=t,this.redoBtn.enabled=e}setFill(t,e){this.fillPreview.setColor(t,e)}setStroke(t,e){this.strokePreview.setColor(t,e)}setInk(t){this.inkBtn.dom.innerText=t.label}setThicknessOption(t){this.thicknessIcon.src="/images/"+t.icon}toggleVisibility(){this.isVisible?this.hide():this.show()}show(){this.isVisible=!0,this.dom.classList.remove("hide")}hide(){this.isVisible=!1,this.dom.classList.add("hide")}},he=kt;var wt=class{constructor(t,e=0,s=1,i=void 0){this.dom=t,i===void 0&&(i=.5+(e+s)),this.slider=this.dom.querySelector(".slider-input"),this.slider.setAttribute("min",e),this.slider.setAttribute("max",s),this.slider.setAttribute("value",i),this.label=this.dom.querySelector(".slider-label"),this.changed=new h,this.slider.addEventListener("input",this.onInput.bind(this))}setLabel(t){this.label.innerText=t}onInput(t){this.changed.dispatch(Number(this.slider.value))}set value(t){this.slider.value=t}get value(){return Number(this.slider.value)}},V=wt;var vt=class{constructor(t){this.dom=B({classes:"settingsList"}),this.changed=new h,this.values={},this.items={};let e=this.onValueChanged.bind(this);for(let s in t){let i=t[s],n=new V(Zt("slider"),i.min,i.max);n.setLabel(i.label),n.changed.add(this.onValueChanged,this,s),this.items[s]=n,this.dom.appendChild(n.dom)}}onValueChanged(t,e){this.values[e]=t,this.changed.dispatch(this.values)}setValues(t){for(let e in t){let s=t[e];this.values[e]=s,this.items[e].value=s}}},ae=vt;var Pt=class{constructor(t,e){this.dom=t,this.items=[],this.template=this.dom.querySelector(".list-item"),this.template.remove(),this.build(e)}clear(){this.dom.querySelector(".list-item").remove(),this.items.length=0}build(t){for(let e=0;e<t;e++){let s=this.template.cloneNode(!0);this.items.push(s),this.dom.append(s)}}},le=Pt;var Ct=class{constructor(t,e){this.dom=this.dom,this.data=e,this.list=new le(t,e.length),this.resetItems(),this.selectedItem=null,this.itemClicked=new h,this.onClickedBind=this.onClicked.bind(this),this.enable()}resetItems(){this.list.items.forEach(this.initItem,this)}initItem(t,e){t.dataset.radioId=e}onClicked(t){var e=t.target.dataset.radioId;e!==void 0&&(t.stopPropagation(),this.selectItemFromId(e),this.itemClicked.dispatch(this.data[e]))}select(t){this.selectedItem&&this.selectedItem.classList.remove("selected"),this.selectedItem=t,this.selectedItem.classList.add("selected")}selectItemFromId(t){this.select(this.list.items[t])}reset(){this.selectedItem!==void 0&&this.selectedItem.classList.remove("selected"),this.selectedItem=void 0}disable(){this.list.dom.removeEventListener("click",this.onClickedBind)}enable(){this.list.dom.addEventListener("click",this.onClickedBind)}},ot=Ct;var rs=`<svg class="inksPanel-interactivePicto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
<rect fill="none" height="24" width="24" x="0"/>
<path d="M9,11.24V7.5C9,6.12,10.12,5,11.5,5S14,6.12,14,7.5v3.74c1.21-0.81,2-2.18,2-3.74C16,5.01,13.99,3,11.5,3S7,5.01,7,7.5 C7,9.06,7.79,10.43,9,11.24z M18.84,15.87l-4.54-2.26c-0.17-0.07-0.35-0.11-0.54-0.11H13v-6C13,6.67,12.33,6,11.5,6 S10,6.67,10,7.5v10.74c-3.6-0.76-3.54-0.75-3.67-0.75c-0.31,0-0.59,0.13-0.79,0.33l-0.79,0.8l4.94,4.94 C9.96,23.83,10.34,24,10.75,24h6.79c0.75,0,1.33-0.55,1.44-1.28l0.75-5.27c0.01-0.07,0.02-0.14,0.02-0.2 C19.75,16.63,19.37,16.09,18.84,15.87z"/></svg>`,bt=class{constructor(t,e){this.dom=t,this.options=e,this.settingsLists=new Map,this.initDom(),this.optionChanged=new h,this.settingsChanged=new h}initDom(){this.optionsList=new ot(this.dom.querySelector(".inksPanel-optionsList"),this.options),this.optionsList.itemClicked.add(this.onOptionClicked,this),this.optionsList.list.items.forEach((t,e)=>{let s=this.options[e];t.innerHTML=`<p>${s.label}</p>${s.isInteractive?rs:""}`}),this.options.forEach(t=>{let e=new ae(t.inkClass.settingsGui);e.setValues(t.inkClass.settings),this.settingsLists.set(t,e)}),this.inkTitleDom=this.dom.querySelector(".inksPanel-inkTitle"),this.settingsContainer=this.dom.querySelector(".inksPanel-settingsContainer")}onOptionClicked(t){this.optionChanged.dispatch(t)}setOption(t){this.currentSettingsList&&(this.currentSettingsList.dom.remove(),this.currentSettingsList.changed.remove(this.settingsChanged.dispatch,this.settingsChanged)),this.inkTitleDom.innerText=t.label;let e=this.settingsLists.get(t);e.changed.add(this.settingsChanged.dispatch,this.settingsChanged),this.settingsContainer.appendChild(e.dom),this.currentSettingsList=e,this.optionsList.selectItemFromId(this.options.indexOf(t)),this.settingsChanged.dispatch(e.values)}setValues(t){this.currentSettingsList.setValues(t)}open(){this.dom.classList.remove("closed")}close(){this.dom.classList.add("closed")}},de=bt;var xt=class{constructor(t){this.dom=t,this.handle=this.dom.querySelector(".customSlider-handle"),this.dom.tabIndex=1,this.mouse=new D(this.dom),this.mouse.onDown.add(this.startDrag,this),this.globalMouse=new D(document.body),this.globalMouse.onMove.add(this.drag,this),this.globalMouse.onUp.add(this.stopDrag,this),this.changed=new h}startDrag(t){this.globalMouse.enable(),this.globalMouse._updatePositionFromEvent(t),this.initPos={gx:this.globalMouse.x,x:this.mouse.x},this.drag()}stopDrag(){this.globalMouse.disable()}drag(){let t=this.globalMouse.x-this.initPos.gx;this.value=(this.initPos.x+t)/this.dom.clientWidth,this.changed.dispatch(this.value)}set value(t){this._value=Math.min(Math.max(t,0),1),this.layout()}get value(){return this._value}layout(){this.handle.style.left=(this.value*this.dom.clientWidth).toString()+"px"}setImage(t){this.dom.style.backgroundImage=t}enable(){this.mouse.enable()}disable(){this.mouse.disable(),this.globalMouse.disable()}},ce=xt;var St=class{constructor(t,e,s){this.max=e,this.makeGradientFunc=s,this.dom=t,this.slider=new ce(this.dom),this.canvas=this.dom.querySelector(".colorPropSlider-canvas"),this.ctx=this.canvas.getContext("2d"),this.changed=new h}onSliderChanged(t){this.changed.dispatch(this.value)}set value(t){this.slider.value=t/this.max}get value(){return this.slider.value*this.max}setColor(t){let e=this.makeGradientFunc(t),s=this.canvas.clientWidth,i=this.canvas.clientHeight;this.canvas.width!==s&&(this.canvas.width=s),this.canvas.height!==i&&(this.canvas.height=i),this.ctx.clearRect(0,0,s,i);let n=this.ctx.createLinearGradient(0,0,s,0);return e.forEach((r,a)=>{n.addColorStop(a/(e.length-1),r.toString())}),this.ctx.fillStyle=n,this.ctx.fillRect(0,0,s,i),this}enable(){this.slider.enable(),this.slider.changed.add(this.onSliderChanged,this)}disable(){this.slider.disable(),this.slider.changed.remove(this.onSliderChanged,this)}},ue=St;var yt=document.createElement("canvas");yt.width=yt.height=1;var me=yt.getContext("2d"),Lt=class{constructor(t,e,s=!0){this.dom=t,this.changed=new h,this.color=new p,this.enabled=!0,this.initSelectors(),s||(this.selectors.a.dom.style.display="none"),this.hexField=this.dom.querySelector(".colorPicker-hexField"),this.hexField.addEventListener("change",this.onHexChanged.bind(this)),this.preview=new e(this.dom.querySelector(".colorPicker-colorPreview")),this.disableBtn=new k(this.dom.querySelector(".colorPicker-disableBtn")),this.disableBtn.clicked.add(this.onDisableClicked,this)}onDisableClicked(){this.enabled=!this.enabled,this.updateColor()}initSelectors(){this.selectors={h:this.initSelector(".colorPicker-hueSelector",360,t=>this.color.h=t,t=>[p.RED,p.YELLOW,p.GREEN,p.CYAN,p.BLUE,p.MAGENTA,p.RED]),s:this.initSelector(".colorPicker-saturationSelector",100,t=>this.color.s=t,t=>[t.clone().setS(0),t.clone().setS(100)]),l:this.initSelector(".colorPicker-lightnessSelector",100,t=>this.color.l=t,t=>[t.clone().setL(0),t.clone().setL(50),t.clone().setL(100)]),a:this.initSelector(".colorPicker-alphaSelector",1,t=>this.color.a=t,t=>[t.clone().setA(0),t.clone().setA(1)])}}initSelector(t,e,s,i){let n=new ue(this.dom.querySelector(t),e,i);return n.changed.add(r=>{s(r),this.updateColor()}),n}onHexChanged(t){let e=t.currentTarget.value;me.fillStyle=e;let s=me.fillStyle;this.color.setHex(parseInt(s.substr(1,6),16)),this.enabled=!0,this.updateColor()}refresh(){this.selectors.h.value=this.color.h,this.selectors.s.value=this.color.s,this.selectors.l.value=this.color.l,this.selectors.a.value=this.color.a,this.selectors.h.setColor(this.color),this.selectors.s.setColor(this.color),this.selectors.l.setColor(this.color),this.selectors.a.setColor(this.color);let t=this.color.getHex().toString(16);for(;t.length<6;)t="0"+t;this.hexField.value="#"+t}updateColor(){this.changed.dispatch(this.color,this.enabled)}setColor(t,e){this.color.copy(t),this.preview.setColor(t,e),this.dom.classList.toggle("light",t.l>80||t.a<.2)}enable(){for(let t in this.selectors)this.selectors[t].enable()}disable(){for(let t in this.selectors)this.selectors[t].disable()}open(){}close(){}},z=Lt;var Et=class{constructor(t,e){this.dom=t,this.colorClicked=new h,this.colors=void 0,this.colorItems=void 0,this.colorsContainer=this.dom.querySelector(".colorPresets-colorsList"),this.itemTemplate=this.colorsContainer.querySelector(".colorPresets-colorItem"),this.itemTemplate.remove(),this.addBtn=new k(this.dom.querySelector(".colorPresets-addBtn")),this.addPreview=new b(this.addBtn.dom),this.addClicked=this.addBtn.clicked,this.removeBtn=new k(this.dom.querySelector(".colorPresets-removeBtn")),this.removePreview=new b(this.removeBtn.dom),this.removeClicked=this.removeBtn.clicked,this.onItemClickedBind=this.onItemClicked.bind(this),this.color=e[0],this.setColors(e)}hasColor(t){let e=t.getHex();return this.colors.some(s=>s.getHex()===e)}setColor(t){this.color=t,this.updateBtns()}updateBtns(){this.hasColor(this.color)?(this.addBtn.dom.classList.add("hide"),this.removeBtn.dom.classList.remove("hide")):(this.addBtn.dom.classList.remove("hide"),this.removeBtn.dom.classList.add("hide")),this.addPreview.setColor(this.color),this.removePreview.setColor(this.color)}setColors(t){this.colorItems&&this.colorItems.forEach(e=>{e.dom.remove()}),this.colors=t,this.colorItems=t.map((e,s)=>{let i=this.itemTemplate.cloneNode(!0);i.dataset.id=s;let n=new b(i);return this.colorsContainer.appendChild(i),n.setColor(e),n}),this.updateBtns()}onItemClicked(t){let e=t.target.dataset.id;e&&this.colorClicked.dispatch(this.colors[e])}enable(){this.colorsContainer.addEventListener("click",this.onItemClickedBind),this.addBtn.enable()}disable(){this.addBtn.disable()}open(){}close(){}},J=Et;var Bt=class{constructor(t,e){this.dom=t,this.colorPicker=new z(this.dom.querySelector(".fillPanel-colorPicker"),b),this.colorChanged=new h,this.addPresetClicked=new h,this.removePresetClicked=new h,this.colorPicker.changed.add((s,i)=>this.colorChanged.dispatch(s,i)),this.presets=new J(this.dom.querySelector(".fillPanel-colorPresets"),e),this.presets.colorClicked.add(s=>this.colorChanged.dispatch(s,!0)),this.presets.addClicked.add(this.onAddClicked,this),this.presets.removeClicked.add(this.onRemoveClicked,this)}onAddClicked(){this.addPresetClicked.dispatch(this.colorPicker.color.clone())}onRemoveClicked(){this.removePresetClicked.dispatch(this.colorPicker.color.clone())}setColor(t,e){this.colorPicker.setColor(t,e),this.colorPicker.refresh(),this.presets.setColor(t,e)}setUserColors(t){this.presets.setColors(t)}open(){this.dom.classList.remove("closed"),this.colorPicker.refresh(),this.colorPicker.open(),this.colorPicker.enable(),this.presets.open(),this.presets.enable()}close(){this.dom.classList.add("closed"),this.presets.close()}enable(){this.colorPicker.enable(),this.presets.enable()}disable(){this.colorPicker.disable(),this.presets.disable()}},pe=Bt;var Mt=class{constructor(t,e){this.dom=t,this.colorPicker=new z(this.dom.querySelector(".strokePanel-colorPicker"),Q),this.colorChanged=new h,this.addPresetClicked=new h,this.removePresetClicked=new h,this.thicknessChanged=new h,this.colorPicker.changed.add((s,i)=>this.colorChanged.dispatch(s,i)),this.presets=new J(this.dom.querySelector(".strokePanel-colorPresets"),e),this.presets.colorClicked.add(s=>this.colorChanged.dispatch(s,!0)),this.presets.addClicked.add(this.onAddClicked,this),this.presets.removeClicked.add(this.onRemoveClicked,this),this.thicknessSlider=new V(this.dom.querySelector(".strokePanel-thicknessSlider"),1,50),this.thicknessSlider.changed.add(s=>this.thicknessChanged.dispatch(s))}onAddClicked(){this.addPresetClicked.dispatch(this.colorPicker.color.clone())}onRemoveClicked(){this.removePresetClicked.dispatch(this.colorPicker.color.clone())}setColor(t,e){this.colorPicker.setColor(t),this.colorPicker.refresh(),this.presets.setColor(t,e)}setUserColors(t){this.presets.setColors(t)}open(){this.dom.classList.remove("closed"),this.colorPicker.refresh(),this.colorPicker.open(),this.colorPicker.enable(),this.presets.open(),this.presets.enable()}close(){this.dom.classList.add("closed"),this.presets.close()}enable(){this.colorPicker.enable(),this.presets.enable()}disable(){this.colorPicker.disable(),this.presets.disable()}setThickness(t){this.thicknessSlider.value=t,this.colorPicker.preview.setThickness(t)}},ge=Mt;var Dt=class{constructor(t,e=!1){this.dom=t,this.checkbox=this.dom.querySelector(".checkbox-input"),this.checkbox.checked=!0,this.label=this.dom.querySelector(".checkbox-label"),this.changed=new h,this.checkbox.addEventListener("input",this.onInput.bind(this))}setLabel(t){this.label.innerText=t}onInput(t){this.changed.dispatch(this.checkbox.checked)}set value(t){this.checkbox.checked=t}get value(){return this.checkbox.checked}},fe=Dt;var Tt=class{constructor(t,e){this.dom=t,this.options=e,this.optionChanged=new h,this.thicknessChanged=new h,this.rotationChanged=new h,this.reflectionChanged=new h,this.initDom()}initDom(){this.optionsList=new ot(this.dom.querySelector(".thicknessPanel-optionsList"),this.options),this.optionsList.itemClicked.add(this.onOptionClicked,this),this.optionsList.list.items.forEach((t,e)=>{t.querySelector(".thicknessPanel-thickness-icon").src="/images/"+this.options[e].icon}),this.thicknessSlider=new V(this.dom.querySelector(".thicknessPanel-thicknessSlider"),1,200),this.thicknessSlider.changed.add(t=>this.thicknessChanged.dispatch(t)),this.rotationSlider=new V(this.dom.querySelector(".thicknessPanel-rotationSlider"),1,6),this.rotationSlider.changed.add(t=>this.rotationChanged.dispatch(t)),this.reflectionCheckbox=new fe(this.dom.querySelector(".thicknessPanel-reflectionCheckbox")),this.reflectionCheckbox.changed.add(t=>this.reflectionChanged.dispatch(t))}onOptionClicked(t){this.optionChanged.dispatch(t)}setOption(t){this.settingsFunc=t,this.optionsList.selectItemFromId(this.options.indexOf(t))}setThickness(t){this.thicknessSlider.value=t}setRotationCount(t){this.rotationSlider.value=t}setReflection(t){this.reflectionCheckbox.value=t}open(){this.dom.classList.remove("closed")}close(){this.dom.classList.add("closed")}},ke=Tt;var Ft=class{constructor(t){this.dom=t}open(){this.dom.classList.remove("closed")}close(){this.dom.classList.add("closed")}},we=Ft;var It=class{constructor(t,e,s){this.updated=new h,this.isPaused=!0,this.frame=0,this.lastPause=0,this.delay=0,t&&(this.updated.add(t,e),(s||s===void 0)&&this.play())}play(){if(!this.isPaused)return;let t=Date.now();this.lastPause=0,this.delay=0,this.frame=0,this.isPaused=!1,this._onUpdate()}_onUpdate(){this.frame++,this.updated.dispatch(Date.now(),this.frame),this.isPaused||(this._requestFrame=requestAnimationFrame(this._onUpdate.bind(this)))}pause(){this.isPaused=!0,this.lastPause=Date.now(),cancelAnimationFrame(this._requestFrame)}resume(){this.isPaused=!1,this._onUpdate()}dispose(){this.onUpdate.dispose(),this.pause()}},nt=It;var x={IDDLE:Symbol("iddle"),RECORDING:Symbol("recording"),EXPORTING:Symbol("exporting"),DONE:Symbol("done")},Rt={width:800,height:600,duration:5},At=class{constructor(t){this.dom=t,this.exportClicked=new h,this.importClicked=new h,this.captureStarted=new h,this.captureStopped=new h,this.saveClicked=new h,this.captureLoop=new nt(this.onCaptureUpdate,this,!1),this.initDom()}initDom(){let t=e=>this.dom.querySelector(e);this.saveSection=t(".sharePanel-save"),this.urlField=t(".sharePanel-save-url"),this.saveBtn=new k(t(".sharePanel-save-btn")),this.saveBtn.clicked.add(e=>this.saveClicked.dispatch()),this.copyLinkBtn=new k(t(".sharePanel-copyLink-btn")),this.copyLinkBtn.clicked.add(this.onCopyLinkClicked,this),this.startCaptureBtn=new k(t(".sharePanel-capture-startBtn")),this.startCaptureBtn.clicked.add(this.onStartCaptureClicked,this),this.progressBarContainer=t(".sharePanel-capture-progress"),this.progressBar=t(".sharePanel-capture-progress_bar"),this.captureDom=t(".sharePanel-capture"),this.exportBtn=new k(t(".sharePanel-exportBtn")),this.exportBtn.clicked.add(e=>this.exportClicked.dispatch()),this.importBtn=new k(t(".sharePanel-importBtn")),this.importBtn.clicked.add(e=>this.importClicked.dispatch())}confirmSave(t){this.saveSection.classList.remove("error"),this.saveSection.classList.add("saved"),this.urlField.value=`https://mutsuacen.com/drawing/${t}`,this.urlField.scrollLeft=this.urlField.scrollWidth}displaySaveError(){this.saveSection.classList.add("error"),this.saveSection.classList.remove("saved")}onCopyLinkClicked(){this.urlField.select(),this.urlField.setSelectionRange(0,99999),document.execCommand("copy")}onStartCaptureClicked(){this.captureStarted.dispatch(Rt.width,Rt.height),this.captureDuration=Rt.duration*1e3,this.captureTimeStart=Date.now(),this.captureLoop.play()}onCaptureUpdate(t){let e=t-this.captureTimeStart;if(e>this.captureDuration){this.onCaptureStop();return}this.setCaptureProgress(e/this.captureDuration)}setCaptureProgress(t){this.progressBar.style.width=Math.round(100*t)+"%"}onCaptureStop(){this.captureLoop.pause(),this.captureStopped.dispatch(),this.captureDom.classList.remove("recording")}setCaptureState(t){let e={[x.IDDLE]:"iddle",[x.RECORDING]:"recording",[x.EXPORTING]:"exporting",[x.DONE]:"done"};for(let s in x)this.captureDom.classList.toggle(e[x[s]],t===x[s])}open(){this.dom.classList.remove("closed")}close(){this.dom.classList.add("closed")}resetSave(){this.urlField.value="",this.urlField.scrollLeft=this.urlField.scrollWidth,this.saveSection.classList.remove("saved","error")}reset(){this.setCaptureState(x.IDDLE),this.resetSave()}},ve=At;var _t=class{constructor(t,e){this.dom=t,this.colorPicker=new z(this.dom.querySelector(".backgroundPanel-colorPicker"),b,!1),this.colorChanged=new h,this.addPresetClicked=new h,this.removePresetClicked=new h,this.colorPicker.changed.add((s,i)=>this.colorChanged.dispatch(s,i)),this.presets=new J(this.dom.querySelector(".backgroundPanel-colorPresets"),e),this.presets.colorClicked.add(s=>this.colorChanged.dispatch(s,!0)),this.presets.addClicked.add(this.onAddClicked,this),this.presets.removeClicked.add(this.onRemoveClicked,this)}onAddClicked(){this.addPresetClicked.dispatch(this.colorPicker.color.clone())}onRemoveClicked(){this.removePresetClicked.dispatch(this.colorPicker.color.clone())}setColor(t){this.colorPicker.setColor(t),this.colorPicker.refresh(),this.presets.setColor(t)}setUserColors(t){this.presets.setColors(t)}open(){this.dom.classList.remove("closed"),this.colorPicker.refresh(),this.colorPicker.open(),this.colorPicker.enable(),this.presets.open(),this.presets.enable()}close(){this.dom.classList.add("closed"),this.presets.close()}enable(){this.colorPicker.enable(),this.presets.enable()}disable(){this.colorPicker.disable(),this.presets.disable()}},Pe=_t;var Nt=class{constructor(t){this.dom=t,this.closeClicked=new h,this.exportClicked=new h,this.initDom()}initDom(){let t=e=>this.dom.querySelector(e);this.closeBtn=new k(t(".detailedPanel-closeBtn")),this.closeBtn.clicked.add(e=>this.closeClicked.dispatch()),this.dom.addEventListener("click",e=>{e.target===this.dom&&this.closeClicked.dispatch()}),this.dataField=t(".exportPanel-dataField"),this.copyBtn=new k(t(".exportPanel-copyBtn")),this.copyBtn.clicked.add(this.onCopyClicked,this),this.exportBtn=new k(t(".exportPanel-fileExportBtn")),this.exportBtn.clicked.add(e=>this.exportClicked.dispatch())}onCopyClicked(){let t=document.createElement("input");t.setAttribute("type","text"),t.value=this.dataField.textContent,this.dom.appendChild(t),t.select(),t.setSelectionRange(0,t.value.length),document.execCommand("copy"),this.dom.removeChild(t);let e=()=>{this.dataField.removeEventListener("animationend",e,!1),this.dataField.classList.remove("copied")};this.dataField.addEventListener("animationend",e,!1),this.dataField.classList.add("copied")}open(){this.dom.classList.remove("closed"),this.dataField.classList.remove("copied")}close(){this.dom.classList.add("closed")}setData(t){this.dataField.textContent=t}},Ce=Nt;var qt="Paste drawing data here",Gt=class{constructor(t){this.dom=t,this.closeClicked=new h,this.importClicked=new h,this.fileSelected=new h,this.initDom()}initDom(){let t=e=>this.dom.querySelector(e);if(this.closeBtn=new k(t(".detailedPanel-closeBtn")),this.closeBtn.clicked.add(e=>this.closeClicked.dispatch()),this.dom.addEventListener("click",e=>{e.target===this.dom&&this.closeClicked.dispatch()}),this.dataField=t(".importPanel-dataField"),this.dataField.addEventListener("focusin",()=>this.onDataFocused()),this.dataField.addEventListener("focusout",()=>this.onDataBlured()),this.clearDataField(),this.importBtn=new k(t(".importPanel-importBtn")),this.importBtn.clicked.add(this.onImportClicked,this),window.File&&window.FileReader&&window.FileList&&window.Blob)this.fileSelector=new re(t(".importPanel-fileSelector")),this.fileSelector.fileSelected.add(e=>this.fileSelected.dispatch(e));else throw new Error("The File APIs are not fully supported in this browser.")}reset(){this.clearDataField()}onImportClicked(){let t=this.dataField.value;t!==""&&t!==qt&&this.importClicked.dispatch(t)}open(){this.fileSelector.enable(),this.dom.classList.remove("closed"),this.reset()}close(){this.fileSelector.disable(),this.dom.classList.add("closed")}onDataFocused(){this.dataField.classList.remove("empty"),this.dataField.value===qt&&(this.dataField.value="")}onDataBlured(){this.dataField.value.trim()===""&&this.clearDataField()}clearDataField(){this.dataField.classList.add("empty"),this.dataField.value=qt}setData(t){this.dataField.textContent=t}},be=Gt;var v={DRAW:"draw",ERASE:"erase",INTERACT:"interact"},S=(o,t,e,s=!1)=>({name:o,label:t,inkClass:e,isInteractive:s}),xe=[S("normal","No Motion",T),S("wave","Wave",F),S("ripple","Ripple",I),S("loop","Loop",A),S("growing","Growing",_),S("fluctuate","Fluctuate",N),S("bend","Bend",q,!0),S("avoid","Avoid",G,!0),S("contract","Contract",O,!0),S("Filament","Filament",U,!0)],rt=(o,t,e)=>({name:o,icon:t,thicknessFunc:e}),Se=[rt("thick1","thicknesses/0.jpg",y.func0),rt("thick1","thicknesses/1.jpg",y.func1),rt("thick2","thicknesses/2.jpg",y.func2),rt("thick3","thicknesses/3.jpg",y.func3)],Ot=class{constructor(t,e){this.dom=t,this.drawingArea=e,this.drawingArea.frameEntered.add(this.onFrameEntered,this),this.pen=new ie(this.drawingArea.dom),this.pen.lineStarted.add(this.onLineStarted,this),this.pen.lineCreated.add(this.onLineCreated,this),this.lineTemplate=new it({width:this.drawingArea.width,height:this.drawingArea.height}),this.gifCapture=new se,this.fileSelected=new h,this.exportClicked=new h,this.importClicked=new h,this.saveClicked=new h,this.drawingCleared=new h,this.onExitBind=this.onExit.bind(this),this.onKeyUpBind=this.onKeyUp.bind(this),this.initGui()}initGui(){let t=e=>this.dom.querySelector(e);this.inksPanel=new de(t(".inksPanel"),xe),this.inksPanel.optionChanged.add(this.setInk,this),this.inksPanel.settingsChanged.add(this.setInkSettings,this),this.inksPanel.close(),this.fillPanel=new pe(t(".fillPanel"),L),this.fillPanel.colorChanged.add(this.onFillChanged,this),this.fillPanel.addPresetClicked.add(this.addPreset,this),this.fillPanel.removePresetClicked.add(this.removePreset,this),this.fillPanel.close(),this.strokePanel=new ge(t(".strokePanel"),L),this.strokePanel.colorChanged.add(this.onStrokeChanged,this),this.strokePanel.addPresetClicked.add(this.addPreset,this),this.strokePanel.removePresetClicked.add(this.removePreset,this),this.strokePanel.thicknessChanged.add(this.onStrokeThicknessChanged,this),this.strokePanel.close(),this.thicknessPanel=new ke(t(".thicknessPanel"),Se),this.thicknessPanel.optionChanged.add(this.setThicknessOption,this),this.thicknessPanel.thicknessChanged.add(this.setThickness,this),this.thicknessPanel.rotationChanged.add(this.setRotation,this),this.thicknessPanel.reflectionChanged.add(this.setReflection,this),this.thicknessPanel.close(),this.backgroundPanel=new Pe(t(".backgroundPanel"),L),this.backgroundPanel.colorChanged.add(this.setBackround,this),this.backgroundPanel.addPresetClicked.add(this.addPreset,this),this.backgroundPanel.removePresetClicked.add(this.removePreset,this),this.backgroundPanel.close(),this.aboutPanel=new we(t(".aboutPanel")),this.aboutPanel.close(),this.exportPanel=new Ce(t(".exportPanel")),this.exportPanel.closeClicked.add(this.closeDetailedPanel,this,this.exportPanel),this.exportPanel.exportClicked.add(this.exportClicked.dispatch,this.exportClicked),this.exportPanel.close(),this.importPanel=new be(t(".importPanel")),this.importPanel.closeClicked.add(this.closeDetailedPanel,this,this.importPanel),this.importPanel.importClicked.add(this.importClicked.dispatch,this.importClicked),this.importPanel.fileSelected.add(e=>this.fileSelected.dispatch(e)),this.importPanel.close(),this.sharePanel=new ve(t(".sharePanel")),this.sharePanel.captureStarted.add(this.startCapture,this),this.sharePanel.captureStopped.add(this.stopCapture,this),this.sharePanel.exportClicked.add(this.openExportPanel,this),this.sharePanel.importClicked.add(this.openDetailedPanel,this,this.importPanel),this.sharePanel.saveClicked.add(this.onSaveClicked,this),this.sharePanel.close(),this.menu=new he(t(".menu")),this.openedPanel=void 0,this.menu.inkClicked.add(this.togglePanel,this,this.inksPanel),this.menu.fillClicked.add(this.togglePanel,this,this.fillPanel),this.menu.strokeClicked.add(this.togglePanel,this,this.strokePanel),this.menu.thicknessClicked.add(this.togglePanel,this,this.thicknessPanel),this.menu.backgroundClicked.add(this.togglePanel,this,this.backgroundPanel),this.menu.aboutClicked.add(this.togglePanel,this,this.aboutPanel),this.menu.shareClicked.add(this.toggleSharePanel,this),this.menu.undoClicked.add(this.undo,this),this.menu.redoClicked.add(this.redo,this),this.menu.modeClicked.add(this.setMode,this),this.menu.clearClicked.add(this.onClearClick,this),this.reset(),this.introTween=new ee,this.panelsContainer=t(".draw-panelsContainer")}reset(){this.setInk(xe[1]),this.setFill(L[0],!0),this.setStroke(L[1],!0),this.setStrokeThickness(1),this.setThicknessOption(Se[2]),this.setThickness(50),this.setRotation(1),this.setReflection(!1),this.setMode(v.DRAW),this.setBackround(p.WHITE),this.updateUserColors(L),this.updateUndoState(),this.sharePanel.reset()}onSaveClicked(){this.saveClicked.dispatch(this.drawing)}onExport(){this.download(JSON.stringify(this.drawing.toMemento()),"drawing")}updateUndoState(){this.drawing?this.menu.setUndoState(this.drawing.currentId!==0,this.drawing.currentId<this.drawing.lines.length):this.menu.setUndoState(!1,!1)}download(t,e){let s="data:text/json;charset=utf-8,"+encodeURIComponent(t),i=B({type:"a",attributes:{href:s,download:e+".json"}});i.click(),i.remove()}togglePanel(t){this.openedPanel===void 0?this.openPanel(t):this.openedPanel!==t?(this.openedPanel.close(),this.openPanel(t)):this.closePanel()}openPanel(t){this.openedPanel=t,this.openedPanel.open(),this.dom.classList.add("panelOpened")}closePanel(){this.openedPanel!==void 0&&(this.openedPanel.close(),this.openedPanel=void 0,this.dom.classList.remove("panelOpened"))}toggleSharePanel(){let t=this.openedPanel;if(t!==void 0&&this.closePanel(),t!==this.sharePanel){let e=this.drawing.getCurrentLine()?.saveId;e&&e!==-1?this.sharePanel.confirmSave(e):this.sharePanel.resetSave(),this.openPanel(this.sharePanel)}}openDetailedPanel(t){t.open(),this.dom.classList.add("detailedPanelOpened"),this.pen.disable(),this.closePanel()}closeDetailedPanel(t){t.close(),this.dom.classList.add("detailedPanelOpened"),this.pen.enable()}openExportPanel(){this.openDetailedPanel(this.exportPanel),this.exportPanel.setData(JSON.stringify(this.drawing.getMemento()))}undo(){this.drawing.undo(),this.updateUndoState()}redo(){this.drawing.redo(),this.updateUndoState()}setMode(t){switch(this.menu.setMode(t),this.mode=t,this.mode){case v.DRAW:this.lineTemplate.isEraser=!1,this.pen.enable();break;case v.ERASE:this.lineTemplate.isEraser=!0,this.pen.enable();break;case v.INTERACT:this.pen.disable();break}}onFillChanged(t,e){this.setFill(t,e),this.setMode(v.DRAW)}onStrokeChanged(t,e){this.setStroke(t,e),this.setMode(v.DRAW)}onStrokeThicknessChanged(t){this.setStrokeThickness(t),this.ensureActiveMode()}onClearClick(){this.drawing.lines.length&&window.confirm("Erase Drawing?")&&this.clear()}clear(){this.drawing.clear(),this.updateUndoState(),this.sharePanel.reset(),this.setMode(v.DRAW),this.drawingCleared.dispatch()}setDrawing(t){this.drawing=t,this.setColors(this.drawing.colors),this.introTween.start(2),this.updateUndoState(),this.setBackround(p.fromString(this.drawing.background))}setInk(t){this.menu.setInk(t),this.lineTemplate.inkClass=t.inkClass,this.lineTemplate.ink=new t.inkClass,this.inksPanel.setOption(t),this.ensureActiveMode()}setInkSettings(t){Object.assign(this.lineTemplate.ink.settings,t),this.inksPanel.setValues(t),this.ensureActiveMode()}setFill(t,e){this.menu.setFill(t,e),this.lineTemplate.setFill(t,e),this.fillPanel.setColor(t,e)}setStroke(t,e){this.menu.setStroke(t,e),this.lineTemplate.setStroke(t,e),this.strokePanel.setColor(t,e)}setStrokeThickness(t){this.lineTemplate.setStrokeThickness(t),this.strokePanel.setThickness(t)}addPreset(t){this.drawing.colors.push(t),this.updateUserColors(this.drawing.colors)}updateUserColors(t){this.fillPanel.setUserColors(t),this.strokePanel.setUserColors(t),this.backgroundPanel.setUserColors(t)}removePreset(t){let e=t.getHex(),s=-1,i=this.drawing.colors.length;for(let n=0;n<i;n++)if(this.drawing.colors[n].getHex()===e){s=n;break}s!==-1&&(this.drawing.colors.splice(s,1),this.fillPanel.setUserColors(this.drawing.colors),this.strokePanel.setUserColors(this.drawing.colors),this.backgroundPanel.setUserColors(this.drawing.colors))}setColors(t){this.drawing.colors=t,this.fillPanel.setUserColors(this.drawing.colors),this.strokePanel.setUserColors(this.drawing.colors),this.backgroundPanel.setUserColors(this.drawing.colors)}setThicknessOption(t){this.menu.setThicknessOption(t),this.lineTemplate.thicknessFunc=t.thicknessFunc,this.thicknessPanel.setOption(t),this.ensureActiveMode()}setThickness(t){this.lineTemplate.thickness=t,this.thicknessPanel.setThickness(t),this.ensureActiveMode()}setRotation(t){this.lineTemplate.transform.count=Math.round(t),this.thicknessPanel.setRotationCount(t),this.ensureActiveMode()}setReflection(t){this.lineTemplate.transform.reflection=t,this.thicknessPanel.setReflection(t),this.ensureActiveMode()}disableFill(){this.lineTemplate.fill.enabled=!1,this.ensureActiveMode()}disableStroke(){this.lineTemplate.stroke.enabled=!1,this.ensureActiveMode()}ensureActiveMode(){this.mode===v.INTERACT&&this.setMode(v.DRAW)}setBackround(t){this.menu.setBackground(t),this.backgroundPanel.setColor(t),this.drawing&&(this.drawing.background=t.toString()),document.body.style.backgroundColor=t.toString()}onLineStarted(){this.closePanel()}onLineCreated(t,e,s){let i=this.lineTemplate.clone();i.setGesture(t,e,s),this.drawing.addLine(i),this.menu.setUndoState(!0,!1)}onFrameEntered(t,e){this.drawingArea.displayDrawing(this.drawing,t,et(this.introTween.value)),this.gifCapture.isCapturing&&e%2&&this.gifCapture.capture(),this.pen.isDrawing&&this.pen.pts.length>2&&(this.lineTemplate.setGesture(this.pen.pts,this.pen.timeBegin,Date.now()),this.drawingArea.displayTempLine(this.lineTemplate,this.drawing.background))}onExit(t){let e=this.drawing.getCurrentLine();if(e&&!e.saveId){let s="";return t.returnValue=s,s}}onResize(){this.drawingArea.onResize(),this.lineTemplate.setResolution({width:this.drawingArea.width,height:this.drawingArea.height})}displaySaveError(){this.sharePanel.displaySaveError()}confirmSave(t){this.sharePanel.confirmSave(t)}startCapture(t,e){this.gifCapture.start(this.drawingArea.dom,t,e),this.sharePanel.setCaptureState(x.RECORDING)}stopCapture(){this.gifCapture.saveProgressed.add(this.onGifSaveProgress,this),this.gifCapture.saveCompleted.add(this.onGifSaveComplete,this),this.gifCapture.stop(),this.sharePanel.setCaptureState(x.EXPORTING)}onGifSaveProgress(t){this.sharePanel.setCaptureProgress(t)}onGifSaveComplete(){this.sharePanel.setCaptureState(x.DONE)}onKeyUp(t){t.key==="m"&&this.menu.toggleVisibility()}enable(){this.pen.enable(),this.drawingArea.enable(),this.drawingArea.frameEntered.add(this.onFrameEntered,this),window.addEventListener("keyup",this.onKeyUpBind),window.addEventListener("beforeunload",this.onExitBind)}disable(){this.pen.disable(),this.drawingArea.disable(),this.drawingArea.frameEntered.remove(this.onFrameEntered,this),window.removeEventListener("keyup",this.onKeyUpBind),window.removeEventListener("beforeunload",this.onExitBind)}},ye=Ot;function Ut(o,t,e,s){let i=[],n=[];return o.forEach((r,a)=>{let l=t[a].clone(),c=e*(l.getLength()+s);l.getLength()!==0&&l.setLength(.5*c),i[a]=r.clone().add(l),n[a]=r.clone().sub(l)}),{l:i,r:n.reverse()}}function Le(o,t,e,s){let i=.75*d.dist(t,e),n=s.clone().setLength(i),r=t.clone().add(n),a=e.clone().add(n);o.bezierCurveTo(r.x,r.y,a.x,a.y,e.x,e.y),r.dispose(),a.dispose(),n.dispose()}function ht(o,t,e){let s=t.length;if(s<2)return;let{l:i,r:n}=e;o.moveTo(i[0].x,i[0].y),j(o,i),Le(o,i[s-1],n[0],t[s-1].clone().sub(t[s-2])),j(o,n),Le(o,n[s-1],i[0],t[0].clone().sub(t[1]))}function Z(o,t,e){o.beginPath(),o.moveTo(t.x+.5*e,t.y),o.arc(t.x,t.y,.5*e,0,2*Math.PI)}function Ee(o,t){let e=.5*t.width,s=.5*t.height,i=2*Math.PI/o,n=Math.cos(i),r=Math.sin(i);return[n,r,-r,n,-n*e+r*s+e,-r*e-n*s+s]}function Be(o){return[-1,0,0,1,o.width,0]}var Vt=class{constructor(t){this.dom=t,this.frameEntered=new h,this.canvas=this.dom,this.ctx=this.canvas.getContext("2d"),this.cleared=!1,this.interact=!0,this.mouse=new D(this.dom),this.mouse.onUp.add(e=>this.interact=!1),this.mouse.onMove.add(e=>this.interact=!0),this.loop=new nt(this.onFrameEntered,this,!1),this.loop.updated.add((e,s)=>this.frameEntered.dispatch(e,s)),this.onResize()}displayDrawing(t,e,s){if(this.cleared)return;this.clear(t.background);let i=t.getVisibleLines(),n=i.length,r=.3,a=(1-r)/n;i.forEach((l,c)=>{this.ctx.save();let u=Math.min(this.width/l.resolution.width,this.height/l.resolution.height),g=.5*(this.width-u*l.resolution.width),m=.5*(this.height-u*l.resolution.height);this.ctx.translate(g,m),this.ctx.scale(u,u);let w=1;if(s<1){let tt=c*a;w=(s-tt)/r,w=C(0,1,w)}let Kt=this.interact?{x:this.mouse.x/u-g/u,y:this.mouse.y/u-m/u}:void 0;l.update(e,Kt,this.canvas),l.result.length>1?this.drawLine(l,w,t.background):this.drawPoint(l,w,t.background),this.ctx.restore()}),this.cleared=!1}drawLine(t,e,s){let i=t.isEraser?{color:s,enabled:!0}:t.fill,n=t.isEraser?{color:s,enabled:!1}:t.stroke,r=Ee(t.transform.count,t.resolution),a=!1,l=t.transform.reflection?2:1,c=Be(t.resolution);if(n.enabled){let u=Ut(t.result,t.normals,e,0);this.ctx.save();for(let g=0;g<l;g++){for(let m=0;m<t.transform.count;m++)this.ctx.lineWidth=e*n.thickness,this.ctx.strokeStyle=n.color,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.transform(...r),this.ctx.beginPath(),ht(this.ctx,t.result,u),this.ctx.stroke();this.ctx.transform(...c)}this.ctx.restore()}if(i.enabled){this.ctx.save();let u=Ut(t.result,t.normals,e,0);for(let g=0;g<l;g++){for(let m=0;m<t.transform.count;m++)this.ctx.fillStyle=i.color,this.ctx.transform(...r),this.ctx.beginPath(),ht(this.ctx,t.result,u),this.ctx.fill();this.ctx.transform(...c)}this.ctx.restore()}}drawPoint(t,e,s){let i=t.isEraser?{color:s,enabled:!0}:t.fill,n=t.isEraser?{color:s,enabled:!1}:t.stroke,r=Ee(t.transform.count,t.resolution),a=t.transform.reflection?2:1,l=Be(t.resolution),c=t.thickness*t.normals[0].getLength(),u=t.result[0],g=n.enabled&&e>0;if(g&&t.strokeMode===H.FILL){this.ctx.save();for(let m=0;m<a;m++){for(let w=0;w<t.transform.count;w++)this.ctx.transform(...r),Z(this.ctx,u,e*(c+t.stroke.thickness)),this.ctx.fillStyle=n.color,this.ctx.fill();this.ctx.transform(...l)}this.ctx.restore()}if(g&&t.strokeMode===H.LINE){this.ctx.save();for(let m=0;m<a;m++){for(let w=0;w<t.transform.count;w++)this.ctx.transform(...r),Z(this.ctx,u,e*c),this.ctx.lineWidth=e*t.stroke.thickness,this.ctx.strokeStyle=n.color,this.ctx.stroke();this.ctx.transform(...l)}this.ctx.restore()}if(i.enabled){this.ctx.save();for(let m=0;m<a;m++){for(let w=0;w<t.transform.count;w++)this.ctx.transform(...r),Z(this.ctx,u,e*c),this.ctx.fillStyle=i.color,this.ctx.fill();this.ctx.transform(...l)}this.ctx.restore()}}displayTempLine(t,e){t.updatePreview(),t.strokeMode=t.getStrokeMode(t.fill),$(this.ctx,t.pts),t.result.length>1&&this.drawLine(t,1,e)}enable(){this.loop.play(),this.mouse.enable()}disable(){this.loop.pause(),this.mouse.disable()}onResize(){this.resize(this.canvas.clientWidth,this.canvas.clientHeight)}resize(t,e){this.canvas.width=t,this.canvas.height=e}get width(){return this.canvas.width}get height(){return this.canvas.height}clear(t){this.ctx.save(),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.cleared=!0}},Me=Vt;function De(o){var t="",e=0;for(var s in o)e++&&(t+="&"),t+=s+"="+o[s];return t}function Te(o,t){return o+(/\?/.test(o)?"&":"?")+t}function Wt(o){var t={};return o&&t.toString.call(o)==="[object Function]"}var jt=class{constructor(t){this.url=t,this.useCache=!0,this.POST={},this.GET={},this.errors=[],this.responseType="text",this.onComplete=new h,this.onError=new h,this.onProgress=new h,this.request=new XMLHttpRequest,this._addListener("progress",this._onProgress),this._addListener("load",this._onData),this._addListener("error",this._onError),this._addListener("abort",this._onError)}_addListener(t,e){this.request.addEventListener(t,e.bind(this))}load(t,e,s,i){Wt(e)&&this.onComplete.add(e,t),Wt(s)&&this.onError.add(s,t),Wt(i)&&this.onProgress.add(i,t);var n=this.url,r=De(this.GET);r.length&&(n=Te(n,r)),this.useCache||(n=Te(n,"t="+new Date().getTime()));var a=De(this.POST),l=this.request;a?l.open("POST",n):l.open("GET",n),l.responseType=this.responseType,l.setRequestHeader("Content-type","application/x-www-form-urlencoded"),l.send(a)}_onProgress(){this.onProgress.dispatch()}_onData(){var t=this.request.response;t===void 0&&(t=this.request.responseText),this.parse(t)}_onError(){this.onError.dispatch(this.errors)}parse(t){this.data=t,this._onParsed()}_onParsed(){this.onComplete.dispatch(this.data)}},Ht=jt;function zt(o){let t=JSON.parse(o);return E.fromMemento(t)}function Fe(o){let t=o.getMemento();hs(JSON.stringify(t),"drawing")}function hs(o,t){let e="data:text;charset=utf-8,"+encodeURIComponent(o),s=B({type:"a",attributes:{href:e,download:t+".json"}});s.click(),s.remove()}var Jt=class extends Ht{constructor(t){super("/api.php");this.GET.action="save_drawing",this.POST.drawing=JSON.stringify(t.getMemento())}parse(){try{let t=JSON.parse(this.request.response);switch(t.status){case 0:this.data=Number(t.id),this._onParsed();break;case 1:default:throw new Error(t.message)}}catch(t){this.errors[0]=t,this._onError();return}}},$t=class extends Ht{constructor(t){super("/api.php");this.GET.action="get_drawing",this.GET.id=t}parse(){try{let t=JSON.parse(this.request.response);switch(t.status){case 0:let e=JSON.parse(t.drawing);this.data=E.fromMemento(e),this._onParsed();break;case 1:default:throw new Error(t.message)}}catch(t){this.errors[0]=t,this._onError();return}}};var Ie=class{constructor(){Qt(document.querySelector(".templates")),this.domElement=document.querySelector(".mainContainer"),this.domElement.style.display="block",this.drawingArea=new Me(this.domElement.querySelector(".drawingArea")),this.currentPage=void 0,this.drawPage=new ye(this.domElement.querySelector(".draw"),this.drawingArea),this.drawPage.setDrawing(new E),this.drawPage.fileSelected.add(this.onFileSelected,this),this.drawPage.exportClicked.add(this.onExported,this),this.drawPage.importClicked.add(this.onImported,this),this.drawPage.saveClicked.add(this.onSaved,this),this.drawPage.drawingCleared.add(this.onCleared,this),this.drawPage.dom.remove(),this.setPath(window.location.hash.split("/").slice(1),!1),window.addEventListener("popstate",t=>this.setPath(t.state.path,!1)),window.addEventListener("resize",this.onResize.bind(this)),this.onResize()}onResize(){this.drawPage.onResize()}setPath(t,e=!0){switch(t[0]){case"drawing":if(t.length>1){let s=t[1];s.match(/[0-9]+/)&&this.loadDrawing(s,e)}else this.drawPage.setDrawing(new E),this.setPage(this.drawPage);break;case"":default:this.drawPage.setDrawing(new E),this.setPage(this.drawPage);break}this.displayPath(t,e)}displayPath(t,e=!0){let s=[{path:t},"Mutsuacen","/"+t.join("/")];e?window.history.pushState(...s):window.history.replaceState(...s)}loadDrawing(t,e=!0){new $t(t).load(null,i=>{i.getCurrentLine().saveId=t,this.displayPath(["drawing",t],e),this.setPage(this.drawPage),this.drawPage.setDrawing(i)},i=>{console.error("Error on Load",i)})}setPage(t){t!==this.currentPage&&(this.currentPage!==void 0&&(this.currentPage.disable(),this.domElement.removeChild(this.currentPage.dom)),this.currentPage=t,this.currentPage.reset(),this.currentPage.enable(),this.domElement.appendChild(this.currentPage.dom))}onDrawingOpened(t){t===void 0?(this.drawPage.setDrawing(new E),this.displayPath(["drawing"])):this.loadDrawing(t),this.setPage(this.drawPage)}onExported(){Fe(this.drawPage.drawing)}onImported(t){this.drawPage.setDrawing(zt(t)),this.drawPage.closeDetailedPanel(this.drawPage.importPanel)}onFileSelected(t){this.drawPage.setDrawing(zt(t)),this.drawPage.closeDetailedPanel(this.drawPage.importPanel)}onSaved(t){let e=t.getCurrentLine();if(e.saveId){this.confirmSave(e.saveId);return}let s=new Jt(t);e.saveId=-1,s.load(null,i=>{e.saveId=i,this.confirmSave(i)},i=>{e.saveId=void 0,console.error("Error on Save",i),this.drawPage.displaySaveError()})}confirmSave(t){this.displayPath(["drawing",t]),this.drawPage.confirmSave(t)}onCleared(){this.displayPath([])}};window.addEventListener("load",o=>{new Ie});})();
